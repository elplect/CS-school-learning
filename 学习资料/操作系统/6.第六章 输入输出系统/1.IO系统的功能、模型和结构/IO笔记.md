## 第六章 输入输出系统

I/O : 管理诸如打印机/扫描机等设备,以及用于存储数据(磁盘驱动器和磁带机等各种存储设备),

I/O系统 : 操作系统中最繁杂且与硬件联系最紧密的部分

### 1.I/O系统的功能、模型和接口

管理的主要对象 : I/O设备和相应的设备控制器

最主要的任务 : 完成用户的I/O请求、提高I/O速率、提高设备的利用率、为更高层的进程方便的使用这些设备

#### 1.I/O系统的基本功能

为了满足系统和用户的需求,I/O系统应具有下述几方面的功能:

1. 方便用户使用I/O设备
   1. 隐藏物理设备的细节
   2. 与设备的无关性
2. 提高CPU和I/O设备的利用率
   1. 提高处理机和I/O设备的利用率
   2. 对I/O设备进行控制
3. 为用户在共享设备时提供方便,以保证系统运行,自动纠错
   1. 确保对设备的正确共享
   2. 错误处理

##### 1.隐藏物理设备的细节

​		I/O设备的类型非常多,彼此间在多方面也存在差异.(接受/产生数据的速度、传输方向、粒度、数据的表示形式和可靠性)...为了对这些设备进行控制,通常为其配置相应的设备控制器.

​		设备控制器 : 硬件设备,包含若干个用于存放控制命令的寄存器和存放参数的寄存器.

​								用户通过这些命令和参数控制外部设备执行所要求的操作.

​		I/O系统通过对设备加以适当的抽象,以隐藏掉物理设备的实现细节,仅向上层进程提供少量的、抽象的读/写命令.

​		隐藏性问题,在第一章做了类似的介绍.

##### 2.与设备的无关性

​		在隐藏物理设备细节的基础上实现的.

​		一方面,用户不仅可以使用抽象的I/O命令,还可以使用抽象的逻辑设备名来使用设备.

​		另一方面,可以有效的提高OS设的可移植性和易适应性.

​		对于OS来说,应允许在不需要将整个操作系统进行重新编译的情况下,添加新的设备驱动程序,以方便新的I/O设备的安装.

##### 3.提高处理机和I/O设备的利用率

​		一般系统中,许多I/O设备间时相互独立的、能并行操作,在处理机和设备之间也能并行操作.

​		因此,I/O系统的第三个功能是要尽可能地让处理机和I/O设备之间并行操作.以提高他们的利用率.为此 :

1. 要求处理机能快速响应用户的I/O请求,使I/O设备尽快地运行起来.
2. 尽量减少每个I/O设备运行时处理机的干预时间.本章中将介绍许多有助于实现该目标的方法.

##### 4.对I/O设备进行控制

​		对I/O设备进行控制是驱动程序的功能.目前对I/O设备有四种控制方式 : 

1. 采用轮询的可编程I/O方式
2. 采用中断的可编程I/O方式
   1. 打印机、键盘终端等低速设备 传输的基本单位 : 字节
3. 直接存储器访问方式 提高系统的利用率
   1. 磁盘、光盘等高速设备 传输的基本单位 : 数据块
4. I/O通道方式
   1. 使对I/O操作的组织和数据的传输,都能独立进行无需CPU的干预.

具体采用何种控制方式,与I/O设备的传输速率、传输的数据单位等因素有关.

为了方便高层和用户,显然I/O软件也应该屏蔽掉这种差异,向高层提供统一的操作系统.

##### 5.确保对设备的正确共享

​		从设备的共享属性上分,可将系统中的设备分为如下两类 : 

1. 独占设备
   1. 进程间互斥访问该设备
2. 共享设备
   1. 一段时间内允许多个进程同时访问的设备. 录入磁盘

##### 6.错误处理

​		大多数设备包含了较多的机械和电气部分,运行时容易出现错误和故障.从处理的角度,可将错误分为临时性错误和持久性错误.

​		临时性错误 : 重试操作

​		持久性错误 : 报告上层

​		在传输过程中发生错误,重复上传多次后,仍有错认为磁盘发生了故障.

​		多数错误与设备紧密相关,因此对于错误的处理,能在低层软件解决的就不向上层报告.因此高层也就不能感知,只有低层软件解决不了的错误才会请求高层软件解决.

#### 2.I/O系统的层次结构和模型

I/O软件涉及的面很宽,向下与硬件有密切关系,向上又与文件系统、虚拟存储器系统和用户直接交互,它们都需要I/O系统来实现I/O操作.

为了让复杂的I/O系统具有清晰的结构、更好的可移植性和易适应性,目前已普遍采用层次式的I/O系统.

##### 1.I/O软件的层次结构

​		通常把I/O软件组织成四个层次

1. 用户层I/O软件
   1. 实现与用户交互的接口,用户可直接调用该层所提供的、与IO操作有关的库函数对设备进行操作.
2. 设备独立性软件
   1. 用于实现用户程序与设备驱动器的统一接口、设备命名、设备的保护以及设备的分配与释放等,同时为设备管理和数据传送提供必要的存储空间
3. 设备驱动程序
   1. 与硬件直接相关,用于具体实现系统对设备发出的操作指令,驱动I/O设备工作的驱动程序
4. 中断处理程序
   1. 用于保存被中断进程的CPU环境,转入相应的中断处理程序进行处理,处理完毕再回复被中断进程的现场后,返回到被中断的进程.

<img src="IO%E7%AC%94%E8%AE%B0.assets/IMG_4932.jpg" alt="IMG_4932" style="zoom:25%;" />

##### 2.I/O系统中各种模块之间的层次视图

​		为了能更清晰描述I/O系统中主要模块之间的关系,我们进一步介绍I/O系统中各种I/O模块之间的层次视图.

<img src="IO%E7%AC%94%E8%AE%B0.assets/IMG_4934.jpg" alt="IMG_4934" style="zoom:25%;" />

1. I/O系统的上、下接口
   1. I/O系统接口
      1. I/O与上层系统之间的接口,向上层提供对设备进行操作的抽象I/O命令.
   2. 软件/硬件接口   (RW/HW接口)
      1. 在它上面 : 中断处理程序和用于不同设别的设备驱动程序
      2. 在它下面 : 各种设备的控制器
2. I/O系统的分层
   1. 中断处理程序
      1. 处于I/O系统的底层,直接与硬件进行交互
      2. I/O设备发出中断请求信号,中断硬件做了初步处理后,便转向中断处理程序.
      3. 首先保存被中断进程的CPU环境、转入相应设备的中断处理程序进行处理
      4. 处理完成后,回复被中断进程的CPU环境,返回断点继续运行.
   2. 设备驱动程序
      1. 位于I/O系统的次底层,是进程和设备控制器之间的通信程序.
      2. 主要功能 : 将上层发来的抽象I/O请求转换为对I/O设备的具体命令和参数,并把它装入到设备控制器中的命令和参数寄存器中,或相反.
      3. 设备驱动程序必须由设备制造厂商提供,而不是OS设计者来提供.
      4. 每当在系统中新增一个新设备时,都需要由安装厂商提供新的驱动程序.
   3. 设备独立性软件
      1. 含义 : I/O软件独立于具体使用的物理设备.
      2. 好处 : 提高了I/O系统的可适应性和可扩展性.
      3. 内容 : 设备命名、设备分配、数据缓冲、数据高速缓冲等一类软件

#### 3.I/O系统接口

在I/O系统与高层之间的接口中,根据设备类型的不同,又进一步分为若干个接口.

<img src="IO%E7%AC%94%E8%AE%B0.assets/IMG_4934.jpg" alt="IMG_4934" style="zoom:25%;" />

I/O系统接口 : 块设备接口、流设备接口、网络接口

##### 1.块设备接口

​		块设备接口 : 块设备管理程序与高层之间的接口.

​		该接口反映了大部分磁盘存储器和光盘存储器的本质特征,用于控制该类设备的输入或输出.

1. 块设备
   1. 数据的存取和传输都是以数据块为单位的设备.
   2. 典型的块设备是磁盘.
   3. 该类设备的基本特征:
      1. 传输速率较高,通常数MB-数十MB/s
      2. 可寻址,即能指定数据的输入源地址及输出的目标地址,可随机地读/写磁盘中的任一块
      3. 磁盘设备的I/O常采用DMA方式
2. 隐藏了磁盘的二维结构    (隐藏了磁盘地址是二维结构的情况)
   1. 块设备接口将磁盘上的所有扇区从 0 ~ n-1 依次编号.  n为硬盘中的扇区总数
   2. 编号后,把磁盘的二维结构改变为一种线性序列.
   3. 在二维结构中,每个扇区的地址需要用磁道号和扇区号来表示.
3. 将抽象命令映射为低层操作
   1. 块设备接口支持上层发来的对文件或设备的打开、读/写和关闭等抽象命令.
   2. 该接口将上述命令映射为设备能识别的较低层具体操作.
      1. 上层发来读磁盘命令,先将抽象命令中的逻辑块号转为 磁盘的盘面、磁道和扇区等.

##### 2.流设备接口/字符设备接口

​		流设备接口是流设备管理程序与高层之间的接口.

​		该接口 反映了 大部分字符设备的本质特征,用于控制字符设备的输入输出.

1. 字符设备
   1. 所谓字符设备是指 : 数据的存取和传输是以字符为单位的设备.  键盘/打印机
   2. 基本特征 : 传输速率低、不可寻址
   3. 在输入/输出时,常采用中断驱动程序
2. get/put操作
   1. 字符设备不可寻找,因而只能采用顺序存取方式.
   2. 通常为字符设备建立一个字符缓冲区(队列),设备的I/O字符流顺序地进入字符缓冲区(读入),或者输出.
   3. 获取字符的方法get, 从字符缓冲区取得一个字符(到内存),将它返回给调用者.
   4. 输出字符的方法put,把字符(从内存)输出到字符缓冲区,以待送出到设备.
3. in-control操作
   1. 为了以统一的方式来处理不同的字符设备.
   2. 通常在流设备接口中提供了一种通用的in-control指令,在指令中包含了许多参数,每个参数表示一个与具体设备相关的特定功能.

##### 3.网络通信接口

​		现代OS都提供了面向网络的功能.但首先还是要通过某种方式把计算机连入互联网上.

​		同时操作系统也必须提供相应的网络软件和网络通信接口.

​		使得计算机能通过网络与网络上的其他计算机通信或上网浏览.



​		