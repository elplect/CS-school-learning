### 3.中断机构和中断处理程序

对于操作系统中的I/O系统,本章采用从低层向高层的介绍方法,从本节开始介绍中断处理程序.

多道程序得以实现的基础 : 中断

中断也是设备管理的基础

为了提高处理机的利用率和实现CPU和I/O设备并行执行,也必须有中断的支持.

中断处理程序 是I/O系统中最低的一层,是整个系统的基础.

#### 1.中断简介

##### 1.中断和陷入

1. 中断
   1. 中断 : CPU对I/O设备发来的中断信号的一种响应.
2. 陷入
   1. CPU内部事件引起的中断

##### 2.中断向量表和中断优先级

1. 中断向量表
   1. 为了处理上的方便,通常为每种设备配以**相应的中断处理程序**,并把该程序的**入口地址放在中断向量表**的一个表项中,并为每一个设备的**中断请求规定一个中断号**,他直接**对应于中断向量表的一个表项**中.
   2. I/O设备发来中断请求信号时,由中断控制器确定该请求的中断号,根据该设备的中断号去查找中断向量表,从中取得该设备中断处理程序的入口地址,这样便可以转入中断处理程序执行.
2. 中断优先级
   1. 实际中: 经常会有多个中断信号源,每个中断源对服务要求的紧急程度并不相同.
   2. 因此 需要为其 规定不同的优先级

##### 3.对多中断源的处理方式

​		对于多中断信号源的情况,当处理机正在处理一个中断时,又来了一个新的中断源.该如何处理.

​		通常有2种处理方式 : 屏蔽(禁止)中断、嵌套中断

1. 屏蔽中断
   1. 处理中断时,屏蔽其他中断.按顺序依次处理中断
2. 嵌套中断
   1. 设置中断优先级的系统中,通常采用这样的这种方式.
   2. 响应优先级最高的. 抢占式

#### 2.中断处理程序

中断处理程序的处理过程可分为下述几个步骤 :

1. 测定是否有未响应的中断信号
   1. 每当设备完成一个字节的处理,设备控制器便向处理器发送一个中断请求信号.
   2. 程序每当执行完当前指令后,处理机都要测试是否有未响应的中断信号.
      1. 没有,继续执行吓一跳指令
      2. 有 ,停止原有进程的执行,准备转去执行中断处理程序,为把处理机的控制权转交给中断处理程序做准备.
2. 保护被中断进程的CPU环境
   1. 硬件自动将处理机状态字(PSW)和保存在程序计数器(PC)中下一条指令的地址保存在**中断保留区(栈)**中
   2. ![IMG_5090](%E4%B8%AD%E6%96%AD%E6%9C%BA%E6%9E%84.assets/IMG_5090.jpg)
3. 转入相应的设备处理程序
   1. **处理机**对各个中断源进行测试,**确定引起本次中断的I/O设备**,并向提供中断信号的设备发送确认信号.
   2. 在该设备收到确认信号后,就**立即取消它所发出的中断请求信号**.
   3. 然后,将相应的**设备中断处理程序**的入口地址装入到**程序计数器**中.
   4. 这样,当处理机运行时,便可自动地转向中断处理程序.
4. 中断处理
   1. 不同的设备,有不同的中断处理程序
   2. 首先,从设备控制器中读取状态,确认是异常中断还是正常中断.
      1. 正常中断 : 结束处理
      2. 异常中断 : 根据发生原因作出相应处理
5. 恢复CPU的现场并退出中断
   1. 恢复CPU现场,是否返回到被中断的进程取决于2个因素
      1. 本中断是否采用了屏蔽中断,是,回到被中断进程
      2. 采用的是中断嵌套方式 : 若有优先级更高的中断请求,先去处理该请求.

<img src="%E4%B8%AD%E6%96%AD%E6%9C%BA%E6%9E%84.assets/IMG_5091.jpg" alt="IMG_5091" style="zoom:33%;" />

I/O操作完成后,驱动程序必须检查本次I/O操作中是否发生了错误,并向上层软件报告,最终向调用者报告本次I/O的执行情况.

部分操作系统会将共同部分集中起来,形成中断总控程序.



