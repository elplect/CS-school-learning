### 2. I/O设备和设备控制器

I/O设备一般是由I/O操作的机械部分和执行控制I/O的电子部件组成.

通常将这两部分分开.

执行控制I/O的电子部件则称为设备控制器或适配器.

#### 1. I/O设备

##### 1.I/O设备的类型

​		能分为 块设备、字符设备、独占设备和共享设备外

​		还可以从设备**使用特性**上分为**存储设备**和**I/O设备**;

​		从设备的**传输速率**上又分为高速设备、中途共享设备和高速共享设备..

1. 按使用特性分类
   1. 第一类是存储设备,也称为外存、辅存,是存储信息的主要设别.
   2. 第二类是I/O设备,它又可分为输入设备、输出设备、交互式设备.
      1. 交互式设备 : 显示器之类
2. 按传输速率分类
   1. 可分为低速设备、中速设备、高速设备
      1. 低速设备 : 键盘、鼠标; 传输速率 几字节到几百字节/s
      2. 中速设备 : 行式打印机、激光打印机等 数千字节到数十万字节/s
      3. 高速设备 : 磁带机、磁盘机、光盘机 数十万字节至千兆字节/s

##### 2.设备与控制器之间的接口

​		通常,设备并不是直接与CPU进行通信,而是与设备控制器通信,因此,在I/O设备中应含有与设备控制器间的接口,在接口中有三种类型的信号,各对应一条信号线.

![image-20201206155922355](%E8%AE%BE%E5%A4%87%E7%AC%94%E8%AE%B0.assets/image-20201206155922355.png)

1. 数据信号线
   1. 用于在设备和设备控制器之间传送数据信号.
   2. 输入设备 : 外界输入信号[转换器]--->缓冲器(规定比特后)[数据信号线]--->设备控制器
   3. 输出设备 : 设备控制器[数据信号线]--->缓冲期(规定比特后)[转换器]--->逐字符输出
2. 控制信号线
   1. 作为设备控制器向I/O设备发送控制信号时的通路.
   2. 该信号规定了设备将要执行的操作
      1. 读操作 : 设备向控制器传送数据
      2. 写操作 : 从控制接受数据
      3. 执行磁盘移动等操作
3. 状态信号线
   1. 用于传送指示设备当前状态的信号
   2. 当前状态 :
      1. 正在读、正在写
      2. 已读、已写

#### 2.设备控制器

设备控制器的主要功能 : 控制一个或多个I/O设备,以实现I/O设备和计算机之间的数据交换.

设备控制器是 : **CPU与I/O设备之间的接口**,接受从CPU发来的命令,控制I/O设备工作,使处理机能够从繁杂的设备控制事物中解脱出来.

设备控制器是一个可编制的设备.

​	当它仅控制一个设备时,他只有一个唯一的设备地址.

​	当它控制多个设备时,他就有多个设备地址.

可把设备控制器分为两类 : 一类适用于控制字符设备的控制器,一类是用于控制块设备的控制器.

##### 1.设备控制器的基本功能

1. 接收和识别命令
   1. 接收识别处理机发来的多种命令.
   2. 在**设备控制器**中具有相应的**控制寄存器**,用来**存放接收的命令和参数**,并对所接受的命令进行**译码**.
      1. 磁盘控制器 : 能接受CPU发来的read、writre、format等15条不同的命令,有些命令还带参数..因此磁盘控制器中有多个寄存器和命令译码器
2. 数据交换
   1. CPU与控制器 : 数据总线,CPU并行地把数据写入控制器,或者从控制器中并行地读出数据
   2. 控制器与设备 : 设备将数据输入到控制器,或者控制器传送给设备. 为此在控制器中**须设置数据寄存器**.
3. 标识和报告设备的状态
   1. 控制器应记下设备的状态供CPU了解
      1. 当CPU处于发送就绪状态时,CPU才能启动控制器从设备中读出数据.
      2. 为此,设备控制器中**需要设置一状态寄存器**
4. 地址识别
   1. 系统中每一个设备都有一个地址,设备控制器必须能够识别其所控制的每个设别的地址.
   2. 因此控制器**应配置地址译码器.**
5. 数据缓冲区
   1. 输出 : 主机数据[缓冲区]{匹配速度}--->I/O设备
   2. 输入 : I/O设备[缓冲区]{高速}--->主机
6. 差错控制
   1. 差错检验码置位

##### 2.设备控制器的组成

![image-20201206164452305](%E8%AE%BE%E5%A4%87%E7%AC%94%E8%AE%B0.assets/image-20201206164452305.png)

​		大多数控制器都是由以下三部分组成的:

1. 设备控制器与CPU的接口
   1. 有三类信号线 : 数据线、地址线、控制线
      1. 数据线 : 通常与两类寄存器相连接
         1. 第一类寄存器 : 数字寄存器 , 在控制器中可以有一个或多个数据寄存器,用于存放输入/输出数据
         2. 第二类寄存器 : 控制/状态寄存器,在控制器中可以有一个或多个,用于存放CPU控制信息和设备状态信息
2. 设备控制器与设备的接口
   1. 一个设备控制器可以控制一个或多个设备
   2. 每个接口都存在数据、控制、状态三种类型的信号.
   3. 控制器中的I/O逻辑根据处理机发来的地址信号去选择一个设备接口
3. I/O逻辑
   1. 用于实现对设备的控制

#### 3.内存映像I/O

驱动程序将抽象I/O命令**转换出的一系列具体的命令、参数**等数据装入**设备控制器**的相应寄存器,由控制器来执行这些命令,具体实施**对I/O设备的控制**.

这一工作可用以下2种方式完成 :

##### 1.利用特定的I/O指令

​		早期计算机,为每个控制寄存器分配一个I/O端口(8位或16位整数),来实现CPU和设备控制器之间的通信.

​		还设置了一些特定的I/O指令.

- 将 CPU寄存器内容 复制到 控制器寄存器
  - io-store  cpu-reg ,   dev-no  dev-reg
    - cpu-reg : CPU中的某个寄存器
    - dev-no : 指定的设备
    - dev-reg : 指定控制器中的寄存器
  - 缺点 ; 访问内存和设备需要两种不同的指令

##### 2.内存映像I/O

​		该方式在编址上不再区分内存单元地址和设备控制器中的寄存器地址,都采用 k 

​				k : 0~n-1   内存地址

​				k : > n		某个控制器的寄存器地址

#### 4.I/O通道

##### 1.I/O通道设备的引入

​		虽然在CPU与I/O设备之间增加了设备控制器后,能大大减少CPU对设备的干预,但主机外设很多,CPU负担依旧大.

​		为此,在CPU和设备控制器之间又增设了 I/O通道.

​		主要目的 : 将CPU从繁杂的I/O设备中解脱出来,因此将原本CPU处理的I/O任务分配给通道了.

​		I/O是一种特殊的处理机,具有执行I/O指令的能力,并通过执行通道程序来控制I/O操作

​		通道与CPU共享内存

##### 2.通道类型

​		通道适用于控制外围设备的,外围设备种类繁多,导致通道也要分类,可分为下述3种 :

1. 字节多路通道
   1. 这是一种按**字节交叉方式**工作的通道.
   2. 它通常都含有许多**非分配型子通道**,其数目从几十到数百个,每**一个子通道连接一台I/O设**备,并控制该设备的I/O操作.这些子通道按时间片轮转方式共享主通道.
   3. 每完成一个字节的传输就交换子通道.
2. 数组选择通道
   1. 字节多路通道不适于连接高速设备,这推动了按数组方式进行数据传送的数组选择通道的形成.
   2. 优点 : 可以连接多台高速设备, 具备很高的传输速度
   3. 缺点 : 只含有一个分配型子通道,在一段时间内只能执行一道通道程序,控制一台设备进行数据传送.直至完成,因 此 通道的利用率很低.
3. 数组多路通道
   1. 结合了上述两者的优点,而形成的一种新通道.
   2. 含有多个非分配型子通道,而数据传送的是数组.
   3. 被广泛使用于连接多台高、中速的外围设备.

##### 3.“瓶颈”问题

​		由于通道价格昂贵--->数量稀少--->限制I/O--->系统吞吐量下降

<img src="%E8%AE%BE%E5%A4%87%E7%AC%94%E8%AE%B0.assets/IMG_5088.jpg" alt="IMG_5088" style="zoom: 33%;" />

解决该问题最有效的方法,就是增加设备到主机的通路,而不是增加通道.<img src="%E8%AE%BE%E5%A4%87%E7%AC%94%E8%AE%B0.assets/IMG_5089.jpg" alt="IMG_5089" style="zoom:33%;" />

