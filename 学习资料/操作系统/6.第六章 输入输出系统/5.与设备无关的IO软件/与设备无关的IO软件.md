### 5.与设备无关的I/O设备

目的 : 用来实现设备独立性(设备无关性),以提高OS的可适应性与可扩展性.

基本含义 : 应用程序中所用的设备,不局限于使用某个具体的物理设备.也就是硬件设备可更换.

具体实现 : 因为设备驱动程序是与硬件紧密相关的,由厂商自己实现,因此,只有这个无法实现.

​					从而,必须在这之上再设置一层软件,称为设备独立性软件.

#### 1.设备独立性软件的基本概念

##### 1.以物理设备名使用设备

##### 2.引入了逻辑设备名

​		/dev/printer

​		该设备名只是说明用户需要使用打印机来打印输出,不指定具体打印机.

​		循环寻找打印机设备进行分配.

​		可实现 I/O重定向(只更换物理设备)

##### 3.逻辑设备名称到物理设备名称的转换

```markdown
	应用程序 : 用的是逻辑地址
```

​		系统分配和使用 : 用的是物理地址

​		需要 一张 逻辑设备表

#### 2.设备独立性软件

设备独立性软件是I/O系统的最高层软件

然后是 设备驱动程序

设备独立性软件,需要以下实现

##### 1.设备驱动程序的统一接口

​		每个设备驱动程序与OS之间有相同的接口

​		将抽象的设备名映射到合适的驱动程序上.进而找到相应物理设备的驱动程序入口.

##### 2.缓冲管理

​		字符设备、块设备的运行速度远低于CPU.因此为之设置了缓冲区(单、双、循环缓冲区、公用缓冲池)

##### 3.差错控制

​		I/O操作的绝大多数错误都与设备有关.  (机械/电气部分)

1. 暂时性错误
   1. 设备出现故障,主要由设备驱动程序处理
   2. 设备独立性软件只处理驱动程序无法处理的问题
2. 持久性错误

##### 4.对独立设备的分配与回收

​		系统中有两类设备 : 独占设备(必须提出请求)、共享设备

​		请求队列等待

##### 5.独立于设备的逻辑数据块

​		提供与设备无关的块大小

​		不同设备,数据交换单位不同、读取传输的速率的也不同.

​		设备独立性软件能隐藏这些差异被逻辑设备使用.

#### 3.设备分配

设备为实现对独占设备的分配,必须在系统中配置相应的数据结构.

##### 1.设备分配中的数据结构

​		该数据结构记录了对设备或控制器进行控制所需的信息.进行设备分配有如下数据结构 : 

1. 设备控制表DCT
   1. 指示设备类型的字段type、设备标识字段deviceid
   2. 设备队列队首指针(设备请求队列)
   3. 忙/闲标志
   4. 控制器表指针
   5. 重复执行次数
2. 控制器控制表、通道控制表、系统设备表
   1. 控制器控制表COCT
      1. 记录控制器情况
   2. 通道控制表CHCT
   3. 系统设备表SDT
   4. ![IMG_5172](%E4%B8%8E%E8%AE%BE%E5%A4%87%E6%97%A0%E5%85%B3%E7%9A%84IO%E8%BD%AF%E4%BB%B6.assets/IMG_5172.jpg)

##### 2.设备分配时应考虑的因素

​		系统分配设备,应考虑以下因素 : 

1. 设备的固有属性
   1. 独占设备的分配策略
   2. 共享设备的分配策略
   3. 虚拟设备的分配策略
2. 设备分配算法
   1. 先来先服务
   2. 优先级算法
3. 设备分配中的安全性
   1. 安全分配方式
      1. I/O阻塞
   2. 不安全分配方式
      1. I/O不阻塞,继续运行

##### 3.独占设备的分配程序

1. 基本的设备分配程序
   1. 分配设备
      1. 根据I/O请求的物理设备名找系统设备表SDT
      2. 根据SDT,找设备DCT
      3. 根据DCT的设备状态字段,判断设备是否忙绿.
         1. 忙 : 挂到将进程的PCB挂到设备队列.
         2. 闲 : 按照一定算法,计算安全性.
            1. 安全 : 分配设备
            2. 不安全 : 将PCB插入设备等待队列.
   2. 分配控制器
      1. 设备分配完后,到设备DCT找与之相连的控制器的COCT
      2. 根据COCT的状态字段判断控制器是否忙绿
         1. 忙 : 将PCB挂在该控制器的等待队列上
   3. 分配通道
      1. 根据COCT,可以找到与控制器相连的通道的CHCT
      2. 根据CHCT中的状态信息可知是否忙绿.
         1. 忙 : 挂到该通道的等待队列上
2. 设备分配程序的改进
   1. 上述是根据物理名分配,改进 : 根据逻辑名分配.
   2. 首先从SDT找第一个设备的DCT.
   3. 忙,找第二个的.
   4. 都忙,挂在设备等待队列上.

#### 4.逻辑设备名到物理设备名映射的实现

实现设备无关性.

##### 1.逻辑设备表LUT

​		表目 : 逻辑设备名、物理设备名、和设备驱动程序的入口地址

![IMG_5173](%E4%B8%8E%E8%AE%BE%E5%A4%87%E6%97%A0%E5%85%B3%E7%9A%84IO%E8%BD%AF%E4%BB%B6.assets/IMG_5173.jpg)

##### 2.逻辑设备表的设置问题

​		系统可采用2种方式设置逻辑设备表 :

1. 整个系统中只设置一张LUT
   1. 不允许有相同逻辑名
   2. 主要用于单用户系统
2. 为每个用户设置一张LUT
   1. 图6-19(b)



