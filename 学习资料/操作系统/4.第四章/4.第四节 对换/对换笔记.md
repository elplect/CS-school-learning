### 4.对换

对换技术也称为交换技术..

对换 : 外内存之间的对换..要实现这点,系统中必须有一台I/O速度较高的外存,并且容量足够大,能容纳正在分时运行的所有用户作业,目前常用的外存设备时大容量磁盘存储器..

笔记记载顺序 : 

1. 从对换的诞生背景讲起,讲述对换的类型及其应用场景.

2. 深入讲述对换空间的管理机制,讲述空间管理需要实现的目标,实现管理的数据结构,以及对该数据结构的具体分配与回收算法. ———— 对换的实现环境,需要有空间来进行对换操作.
3. 细讲如何实现对换功能.

#### 1.多道程序环境下的对换技术

##### 1.对换的引入

​		在多道程序环境下,一方面,占用内存的进程被阻塞,却占着资源不放,迫使CPU停止运行.另一方面,因为内存不足,无法进入的可运行进程一直停留在外存. 这是对资源的严重浪费.

​		为了解决上述问题,在系统中增设了对换设施...

> ​	所谓“对换”,就是将内存中不能运行的进程、程序、数据换到外存,腾出内存空间留给需要的进程、或进程需要的程序和数据换入内存..
>
> ​	对换的作用 : 改善内存利用率的有效措施,提高处理机的利用率和系统的吞吐量

​		实现方法 : 设置一个对换进程,由他来将内存里的进程和外存里的进程实现对换.

​		系统实现所需功能 : 对对换空间的管理、进程的换出、进程的换入

##### 2.对换的类型

​		每次对换,都是将一定数量的程序或数据换入或换出内存.根据每次对换时所对换的数量,可将对换分为如下两类 :

1. 整体对换
   1. 处理机中级调度实际就是存储器的对换功能
   2. 目的 : 解决内存紧张问题,进一步调高内存的利用率和系统的吞吐量
   3. 应用场景 : 广泛应用于多道程序系统中,并作为处理机中级调度
2. 页面对换
   1. 对换的单位是 进程的一个“页面”或“分段”
   2. 目的 : 为了支持虚拟存储系统
   3. 应用场景 : 请求分页和请求分段式存储管理的基础

#### 2.对换空间的管理

在具有对换功能的OS中,通常把磁盘空间分为文件区和对换区两部分.

1.对对换空间管理的主要目标

1. 对**文件区**管理的主要目标 **离散分配方式**
   1. 文件区占用磁盘空间的大部分,用于存放各类文件,由于通常的文件都是较长时间地驻留在外存上,**访问频率低**,故对文件区管理的**主要目标是提高文件存储空间的利用率,其次才是提高对文件的访问速度.因此,对文件区的管理采用离散分配方式.**

2. 对**对换区**管理的主要目标 **连续分配方式**
   1. 只占磁盘空间的一部分,用来存放从内存换出的进程.由于这些进程在对换区中驻留的时间是短暂的,而**对换操作的频率却较高**,故管理的主要目标是 **提高进程换入和换出的速度,然后才是提高文件存储空间的利用率..为此,对对换区的管理采用连续分配方式,较少考虑外存中的碎片问题.**

##### 2.对换区空闲盘块管理中的数据结构

​		为了实现对对换区中的空闲盘块的管理,在系统中应配置相应的**数据结构**,用于记录**外存对换区中的空闲盘块的使用情况**.

数据结构 : 用空闲分区表/链

​					每个表目应该包括两项 : 对换区的首址及大小,分配别用盘块符和盘块数表示.

##### 3.对换空间的分配与回收

​		由于对换分区的**分配**采用的是连续分配方式,因此分配算法与动态分区分配算法类似.

​		对换区的回收也与动态分区分配相同.(4.3.3)

#### 3.进程的换入与换出

内核执行某操作发现内存不够,便会调用对换进程,实现进程的换入和换出.

交换一个进程时间开销很大,处理机的利用率很低.

目前常用的对换方案是,在**处理机正常运行时并不启动对换程序**,在发现有许多进程**在运行时经常发生缺页且出现内存紧张**的情况,再启动对换程序,将一部分进程调至外存.直到**缺页率明显降低**,**系统吞吐量下降**时**停止运行对换程序**.

##### 1.进程的换出

​		将内存的进程换出到外存里的对换区.过程分为两步:

1. 选择被换出的进程
   1. 阻塞或睡眠状态的进程
   2. 优先级低的进程
   3. 进程在内存的驻留时间
   4. 就绪进程
2. 进程换出过程
   1. 只换出该进程独占的资源
   2. 申请对换空间
      1. 成功,启动磁盘,将该进程的程序和数据移至磁盘的对换区
   3. 回收进程所占内存空间
      1. 对该进程的进程控制块和内存分配表等数据结构进行修改
   4. 重复2、3直到内存中无再阻塞进程

##### 2.进程的换入

​		对换进程将定时执行换入操作

1. 查看PCB集合中所有进程的状态
   1. 找出“就绪已换出”的进程
   2. 选择换出时间最久的进程作为换入进程,为其申请内存
      1. 成功,将进程从外存调至内存
      2. 失败,将内存中的某些进程 换出,腾出空间,再调入.
2. 重复1操作,直到再无“就绪已换出”的进程,或无足够内存空间