

### 3.进程调度

进程调度是对系统性能影响最大的一种处理机调度.

#### 1.进程调度的任务、机制和方式

##### 1.进程调度的任务

1. 保存处理机的现场信息
   1. 程序计数器、多个通用寄存器中的内容等
2. 按照某种算法选取进程
   1. 就绪状态->运行状态
3. 把处理器分配给进程
   1. 进程控制块内有关处理机现场的信息装入处理器相应的各个寄存器中

#####  2.进程调度机制

​		为了实现进程调度,在进程调度机制中,应具有如下三个基本部分

1. 排队器
   1. 实现 就绪队列
2. 分派器
   1. 从就绪队列选出一个进程.然后进行从分派器到新选出进程间的上下文切换,将处理机分配给新选出的进程.
3. 上下文切换器
   1. 第一对上下文切换时,OS保存当前进程的上下文,把处理器寄存器内容保存到PCB内的相应单元,在装入分派程序的上下文,以便分派程序运行
   2. 第二队上下文切换 : 移出分派程序的上下文,把新选进程的CPU现场信息装入到处理机各个相应寄存器中,以便进程运行.

![IMG_4743](https://gitee.com/elplect/personal-image-bed/raw/master/beautyImg/IMG_4743.jpg)

在进行上下文切换时,需要执行大量的load和store等操作指令,以保存寄存器内容..每一次上下文切换所花费的时间大约可执行上千条指令.为此,现在已有靠硬件实现的方法来减少上下文切换时间,一般采用两组或多组寄存器,其中一组寄存器供处理机在系统态使用,另一组寄存器供应用程序使用.在这样条件下的上下文切换,只需改变指针,指向当前寄存器组即可.

##### 3.进程调度方式

1. 非抢占方式
   1. 把处理机分配给某进程,就让它一直运行下去
2. 抢占方式
   1. 允许调度程序根据某种原则,去停止某个正在执行的进程,将已分配给该进程的处理机重新分配给另一个进程.
   2. 原则 : 
      1. 优先权原则
      2. 短进程优先原则
      3. 时间片原则

#### 2.轮转调度算法

分时系统中,最简单最常见的是基于时间片的轮转调度算法.

##### 1.轮转法的基本原理

​		在轮转法中,系统根据FCFS策略,将所有就绪进程排列成一个就绪列表.并设置每隔一定时间产生一次中断.激活系统中的进程调度程序,完成一次调度.将CPU分配给新的队首进程.

##### 2.进程切换时机

​		在合适进行进程的切换,分为两种情况

1. 若一个时间片未用完,进程便已完成,就立刻激活调度程序,把它从就绪队列中删除,再调度就绪队列队首的进程运行,启动一个新的时间片
2. 时间片用完,计时器中断程序激活,进程未执行完,调度程序把它送往就绪队列.

##### 3.时间片大小的确定

​		轮转算法中,时间片的大小对系统性能有很大的影响.

​		选择很小的时间片 : 有利于短作业,因为它能在该时间片内完成. 但时间片小,意味着频繁进程调度和上下文切换,会产生大量的开销.

​		选择很长的时间片 : 就退化为了FCFS算法,无法满足短作业和交互式用户的需求.

​		较为可取的时间片大小 : 略大于一次典型交互所需要的时间.使大多数交互式进程能在一个时间片完成,同时时间又很短.

#### 3.优先级调度算法

在时间片轮转调度算法中,做了一个隐含的假设,即系统中所有进程的紧迫性都是一样的.但实际并非如此.

##### 1.优先级调度算法的类型

1. 非抢占式优先级调度算法
2. 抢占式优先级调度算法

##### 2.优先级的类型

优先级调度算法的关键 : 应如何确定进程的优先级,以及确定是使用静态优先级还是动态优先级

1. 静态优先级 创建进程的时候确定的,运行期间不变
   1. 进程类型
      1. 通常系统进程高于一般用户进程
   2. 进程对资源的需求
      1. 资源需求少的,优先级高
   3. 用户需求
      1. 根据进程紧迫程度和用户所付费用的多少确定优先级
   4. 优缺点 : 简单易行,系统开销小,但不够精确.可能出现优先级低的进程长期没有被调度的情况
2. 动态优先级
   1. 创建初期先赋予一个优先级,然后随着进程的推进或等待时间的增加而改变.



#### 4.多队列调度算法

单一就绪队列,**无法满足系统中不同用户对进程调度策略的不同需求**.在多处理机,这种单一调度策略实现机制的缺点就更突出了.而多级队列调度算法能一定程度上弥补这一缺点.

该算法将系统中的进程就绪队列从一个变为多个,将不同类型或性质的进程固定分配在不同的就绪队列,不同的就绪队列采取不同的调度算法.一个就绪队列中的进程可以设置不同优先级,不同就绪队列之间也可以设置优先级.

多处理机,由于设置了多个就绪队列,也很方便为每个处理器设置一个单独的就绪队列.这样不仅 :

1. 每个处理机的调度可以实施不同的调度策略
2. 对含有多线程的进程而言,可以根据需求将所有线程分配在一个就绪列队上,在一个处理机上运行
3. 对于需要互相合作的进程或线程,也可以将其分配在一组处理机所对应的多个就绪队列,让它们能同时获得处理机并行执行.

#### 5.多级反馈队列调度算法

> 目前公认的一种较好的进程调度算法.

前面的各种调度算法都有一定的局限性.如果未指明进程长度,则短进程优先和基于进程长度的抢占式调度算法将无法使用. 而该调度算法不必事先知道各进程所需的执行时间,还可以较好的满足各种类型进程的需求..

##### 1.调度机制

1. 设置多个就绪队列
   1. 为每个队列设置不同优先级.第一个最高,然后逐级降低.
   2. 每个队列中的进程赋予的执行时间片大小也不同, 优先级越高的时间片越小.
2. 每个队列采用FCFS算法
   1. 时间片内执行完,就撤离系统.
   2. 时间片内未执行完 :
      1. 新进程进入内存时,将它放入第一队列的末尾. 按FCFS原则等待
      2. 转入第二队列的末尾等待....
      3. 被降为第n队列,按照RR方式运行.
3. 按队列优先级调度
   1. 调度程序首先调度最高优先级队列中的进程运行
   2. 第一队列空闲后,再调度第二队列中的进程运行.......

##### 2.调度算法的性能

​		该调度算法中,若规定第一队列的时间片略大于多数人机交互所需处理时间时,便能较好的满足各类用户的需求.

1. 终端用户
   1. 提交的作业多为交互型作业,通常较小,系统只要能使这些作业在第一队列规定时间内完成就好
2. 短批处理作业用户
   1. 若在第一队列,则等同于终端用户.即使稍长的短作业,也只要在第二、三队列各执行一段时间片完成,周转时间也很短
3. 长批处理作业用户
   1. 将依次在1-n队列运行,再按照轮转方式运行,不必担心作业长期得不到处理

#### 6.给予公平原则的调度算法

上述都只保证了优先运行..不保证进程占据多少处理机时间.也不保证公平.

##### 1.保证调度算法

​		做出的保证是 明确的性能保证.可以做到调度的公平性.

​		一种比较容易实现方式是 处理机分配的公平性.为保证这点,实施该算法时系统必须具备以下功能 : 

1. 跟踪计算每个进程自创建以来已经执行的处理时间 (**已执行的处理时间**)
2. 计算每个进程**应该获得的处理机时间**,即自创建以来的时间(**获得时间+非获得时间**)/n
3. **计算**进程获得处理机时间的**比率**,即**进程实际执行的处理时间和应获得的处理机时间之比**
4. **比较**各进程获得处理机时间的**比率**.
5. 调度程序应**选择比率最小的进程**将处理机分配给它.并让该进程一直运行,直到**超过最接近它的进程比率为止**.

##### 2.公平分享调度算法

​		分配给进程相同的处理机时间,对进程是公平了.但是对用户不公平.该算法,公平性主要针对用户而言.使用户能获得相同的时间或要求的时间比例...



