### 2.请求分页存储管理方式

**请求分页系统** = 分页系统 + 请求调页 + 页面置换

每次调入调出的基本单位都是长度固定的页面

实现比请求分段简单,**因此称为目前最常用的一种实现虚拟存储器的方式.**

#### 1.请求分页中的硬件支持

为了实现请求分页,系统必须提供一定的硬件支持.

计算机系统 : 内存 + 外存 + 请求页表机制 + 缺页中断机制 + 地址变换机构

##### 1.请求页表机制

1. 主要数据结构 : 请求页表

   1. 基本作用 : 将用户地址空间的逻辑地址映射为内存空间中的物理地址

   2. 页表组成 :

   3. | 页号 | 物理块号 | 状态位P        | 访问字段A        | 修改为M        | 外存地址                |
      | ---- | -------- | -------------- | ---------------- | -------------- | ----------------------- |
      |      |          | 程序访问时参考 | 选择换出页面参考 | 置换页面时参考 | 物理块号,调入该页时参考 |

##### 2.缺页中断机构

​		一般中断需要 : 保护CPU环境、分析中断原因、转入缺页中断处理程序 ;  中断完成后 : 恢复CPU环境

缺页中断特殊在 : 

1. 在指令执行期间产生和处理中断信号.
2. 一条指令在执行期间可能产生多次缺页中断.
   1. 应该能保存多次中断时的状态,并保证最后能返回到中断前产生缺页中断的指令继续执行

##### 3.地址变换机构

![IMG_4854](%E5%88%86%E9%A1%B5%E7%AC%94%E8%AE%B0.assets/IMG_4854.jpg)

#### 2.请求分页中的内存分配

在为进程分配内存时,涉及三个问题 : 

1. 为保证进程能正常运行,需要的最小物理块数的确定
2. 为每个进程分配物理块时,应采取什么样的分配策略,即分配的物理块是固定的还是可变的.
3. 为不同的进程所分配的物理块数,是采取平均分配算法,还是根据进程的大小按比例分配.

##### 1.最小物理块数的确定

​		随着为每个进程所分配的物理块数的减少,将使进程在执行中的缺页率上升.从而降低进程的执行速度额,应该为其分配一定数目的物理块数.

​		最小物理块 : 能保证进程正常运行所需的最小物理块数.少于此值,进程将无法运行. 该值的大小取决于指令的格式、功能和寻址方式.

##### 2.内存分配策略

​		请求分页系统中,可采用两种内存分配策略,固定和可变分配策略.

​		进行置换时,也可以采取两种策略,即全局置换和局部置换.

​		内存分配和置换可组合出3种适用的策略.

​		页面置换我算法评价标准 : 缺页发生频率少,避免系统抖动; 算法本身复杂度低

1. 固定分配局部置换
   1. 固定分配 : 为每个进程分配一组固定数目的物理块,进程运行期间不再改变
   2. 局部置换 : 发现缺页,从分配给该进程的n个页面中选出一页换出,再调入一页,**保证分配给该进程的内存空间不变**.
   3. 为进程分配多少物理块 : 取决于进程类型(交互型/批处理型)、程序员、程序管理员的建议确定.
   4. 实现困难 : 应为每个进程分配多少物理块难以确定.
2. 可变分配全局置换(易于实现,已用于OS中)
   1. 可变分配 : 物理块在进程运行期间可以改变
   2. 先给每个进程分配一定数目的物理块,OS保留一个空闲物理块队列.
   3. 当某进程缺页时,系统从空闲物理块队列,取出一个物理块分配给该进程
   4. 仅当空闲物理块用完,OS采用内存中选择一页调出.
3. 可变分配局部置换
   1. 为每个进程分配一定数目的物理块
   2. 换页只能从该进程的n个页面中选出一页换出
   3. 进程频繁缺页,则系统再为之分配若干物理块.反之则反.

##### 3.物理块分配算法

1. 平均分配算法
   1. 将系统中所有可供分配的物理块,平均分配给各个进程
2. 按比例分配算法
   1. 根据进程的大小按比例分配物理块的算法
   2. S为总页面数,Si为进程页面数,m为物理块总数 : ![image-20201123182656229](%E5%88%86%E9%A1%B5%E7%AC%94%E8%AE%B0.assets/image-20201123182656229.png)
3. 考虑优先权的分配算法
   1. 物理块分成两个部分 : 一部分按照比例分配给各进程,另一部分按照优先权分配
   2. 优先权高的进程分配的数目多些
   3. 有些系统比如实时控制系统,可能完全按照优先权为各进程分配物理块

#### 3.页面调入策略

为使进程能够正常运行,必须事先将要执行的那部分程序和数据所在的页面调入内存.问题 :

1. 系统应在何时调入所需页面
2. 系统应从何处调入这些页面
3. 是如何进行调入的

##### 1.何时调入页面

​		为了确定时机,可采取预调页策略或请求调页策略.

1. 预调页策略
   1. 将那些预计在不久之后会被访问的页面预先调入内存，目前成功率仅约50%
2. 请求调页策略
   1. 进程在运行中，访问的页面不在内存，由OS调入.目前采用。
   2. 易于实现,大多采用此种策略..但是每次仅调入一页,故花费较大的系统开销,增加了磁盘I/O的启动频率.

##### 2.从何处调入页面

​		将请求分页系统的外存分为两部分:用于存放文件的文件区、用于存放对换页面的对换区

​		对换区:连续存储、 文件区:离散存储、 对换区读取速度>文件区

1. 系统有足够的对换区空间
   1. 运行前,文件区的文件拷贝到对换区
2. 系统缺少足够的对换区空间
   1. 不会被修改的文件,直接从文件区调入
   2. 可能被修改的,在换出前必须调到对换区,以后有需要再从对换区调入.
3. UNIX方式
   1. 由于与进程有关的文件都放在文件区
   2. 凡是未运行过的页面都从文件区调入.
   3. 被调入后调出的放在对换区
   4. 允许各进程之间页面共享

##### 3.页面调入过程

1. 程序要访问的页面不在内存时,便向CPU发出一缺页中断.
2. 中断程序首先保留CPU环境,分析中断原因.转入缺页中断处理程序
3. 查找页表得到得到该页在外存的物理块后,若内存能容纳新页,启动磁盘I/O,将其调入内存,然后修改页表
   1. 若内存已满,按照某种置换算法,换出一个页面.若该页未被修改(修改位为0),可不必写回磁盘.再将缺失页换入,存在位 置1,更新快表

##### 4.缺页率

​		进程逻辑空间n页、内存物理块数m块、访问页面成功次数S次、失败次数F次.页面总访问次数A=S+F

- 缺页率 : f=F/A
- 影响因素 : 页面大小、进程所分配物理块数、程序固有特性

假设被置换的页面被修改的概率是b,其缺页中断时间为t~b~,被置换页面没有被修改的中断时间为t~b~

- 缺页中断处理时间 : t = b x t~a~ + (1-b) x t~b~



